<!DOCTYPE html>
<html>

<head>
    <title>Websocket JS client</title>
</head>

<body>
    <h1>JS Websocket test</h1>
    <script type="text/javascript" src="signalr.min.js"></script>
    <script type="text/javascript" src="rot.min.js"></script>

    <script type="text/javascript">
        var connection = new signalR.HubConnectionBuilder()
            .withUrl('http://127.0.0.1:5000/ws')
            .build();

        var display = new ROT.Display({ width: 15, height: 30 });
        document.body.appendChild(display.getContainer());

        connection.on("direct", data => {
            var response = JSON.parse(data);
            if (response.ResponseType === 'gamestatus') {
                var status = JSON.parse(response.Payload);
                var map = status.Map;
                var posx = status.X;
                var posy = status.Y;

                for (var y = 0; y < map.Height; ++y) {
                    for (var x = 0; x < map.Width; ++x) {
                        var cell = map.Cells[y][x];

                        var cellSymbol = cell.IsWalkable ? ' ' : '#';
                        if (posx == x && posy == y) {
                            cellSymbol = '@';
                        }
                        display.draw(x, y, cellSymbol, "rgb(127, 127, 127)");
                    }
                }
            }
            else {
                console.log(response.Payload);
            }
        });

        connection.start()
            .then(() => connection.invoke("SendAsync", '{ RequestName: "Authenticate", Payload: "arch;1234" }'))
            .then(() => connection.invoke("SendAsync", '{ RequestName: "lobby.newgame" }'));

        window.addEventListener("keypress", function (e) {
            var code = e.charCode;
            var ch = String.fromCharCode(code);
            console.log('pressed: ' + ch);
            var o = {
                RequestName: 'Action.Movement',
                Payload: JSON.stringify({ OwnerId: 1, Name: 'Action.Movement', MovementDirection: 3 })
            };
            var movement = { OwnerId: 1, Name: 'Action.Movement', MovementDirection: 0 }
            if (ch === "w") {
                movement.MovementDirection = 2;
            }
            else if (ch === "s") {
                movement.MovementDirection = 3;
            }
            else if (ch === "a") {
                movement.MovementDirection = 0;
            }
            else if (ch === "d") {
                movement.MovementDirection = 1;
            }
            else {
                return;
            }
            o.Payload = JSON.stringify(movement);
            connection.invoke("SendAsync", JSON.stringify(o));
        });

    </script>
</body>

</html>