<!DOCTYPE html>
<html>

<head>
    <title>Websocket JS client</title>
</head>

<body>
    <h1>JS Websocket test</h1>
    <script type="text/javascript" src="signalr.min.js"></script>
    <script type="text/javascript" src="rot.min.js"></script>

    <script type="text/javascript">

        var connection = new signalR.HubConnectionBuilder()
            .withUrl('http://127.0.0.1:5000/ws')
            .build();

        var display = new ROT.Display({ width: 15, height: 30 });
        document.body.appendChild(display.getContainer());

        connection.on("direct", data => {
            var response = JSON.parse(data);
            if (response.ResponseType === 'gamestatus') {
                var status = JSON.parse(response.Payload);
                var map = status.Map;
                var posx = status.X;
                var posy = status.Y;

                for (var y = 0; y < map.Height; ++y) {
                    for (var x = 0; x < map.Width; ++x) {
                        var cell = map.Cells[y][x];

                        var cellSymbol = cell.IsWalkable ? ' ' : '#';
                        if (posx == x && posy == y) {
                            cellSymbol = '@';
                        }
                        display.draw(x, y, cellSymbol, "rgb(127, 127, 127)");
                    }
                }
            }
            else {
                console.log(response.Payload);
            }
        });

        connection.start()
            .then(() => connection.invoke("SendAsync", '{ RequestName: "Authenticate", Payload: "arch;1234" }'))
            .then(() => connection.invoke("SendAsync", '{ RequestName: "lobby.newgame" }'));

    </script>
</body>

</html>